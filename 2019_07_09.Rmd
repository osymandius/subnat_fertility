---
title: "Estimation of subnational fertility in SSA"
author: "Oli Stevens"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
  keep_md: true
# vignette: >
#   %\VignetteIndexEntry{Model-based smoothing of child mortality trends}
# %\VignetteEngine{knitr::rmarkdown}
# %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  cache = TRUE,
  comment = "#>"
)
```

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 600)
```

This is some intro text about how I went and did the thing.

## Load packages

```{r load packages, results=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(rdhs)
library(demogsurv)
library(lme4)
```


## Calculate ASFR, TFR, and GFR

Use `rdhs` and `demogsurv` to calculate ASFR & TFR for Malawi.

```{r datasets}

##+ datasets
surveys <- dhs_surveys(countryIds = "MW", surveyYearStart=1995)
ird <- dhs_datasets(fileType = "IR", fileFormat = "flat", surveyIds = surveys$SurveyId)
ird$path <- unlist(get_datasets(ird))
```

## Load the datasets into R as a list and asssign survey-level variables

```{r load datasets}
ir <- lapply(ird$path, readRDS) %>%
  Map(data.frame,
      surveyid = surveys$SurveyId,
      country = surveys$CountryName,
      survyear = surveys$SurveyYear,
      survtype = surveys$SurveyType,
      .,
      stringsAsFactors = FALSE)
      
```
## Calculate TFR 

Calculate annual (calendar periods) TFR estimates for 0-10 years preceding each DHS survey or 0 to 5 years preceding each MIS.

```{r}
tips_surv <- list("DHS" = c(0, 10), "MIS" = c(0, 5))[surveys$SurveyType]

```

Calculate TFR by survey year & urban/rural (`v025`)

```{r calculate tfrs, warning=FALSE}
tfr <- Map(calc_tfr, ir,
           by = list(~surveyid + country + survyear + v025),
           tips = tips_surv,
           period = list(1995:2017))

tfr <- tfr %>%
  bind_rows %>%
  type.convert %>% 
  mutate(v025 = factor(v025, levels= c(1,2), labels = c("Urban", "Rural"))) %>%
  filter(period <= survyear) %>%
  mutate(lower = tfr - qnorm(0.975) * se_tfr,
         upper = tfr + qnorm(0.975) * se_tfr)
```

## Plot annual TFR estimates

```{r echo=FALSE, warning=FALSE, fig.show='hold', fig.height=3.8, fig.width=8.0, fig.align = "center"}
ggplot(tfr, aes(period, tfr, ymin = lower, ymax = upper,
                color=surveyid, fill=surveyid)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha=0.2, linetype="blank") +
  ggtitle("TFR") +
  theme(legend.position="bottom") +
  # ylim(0, 12.5) +
  facet_grid(~v025)
```

# Fixed effects model

## Calculate ASFR and births / PYs

Calculate annual (calendar periods) TFR estimates for 0-10 years preceding each DHS survey or 0 to 5 years preceding each MIS. Argument `counts = TRUE`indicates to return the counts of weighted births and person-years.


```{r calculate asfrs, warning = FALSE}
asfr <- Map(calc_asfr, ir,
            by = list(~surveyid + country + survyear+ v025),
            tips = tips_surv,
            period = list(1995:2017),
            counts = TRUE)


asfr <- asfr %>%
  bind_rows %>%
  type.convert %>%
  mutate(v025 = factor(v025, levels= c(1,2), labels = c("Urban", "Rural"))) %>%
  filter(period <= survyear)

```

## Fit model

Fit Poisson GLM with log-linear time trend for each age group & fixed effect for urbal/rural

``` {r warning = FALSE}
mod <- glm(births ~ agegr*period + v025, family = poisson, data = asfr, offset = log(pys))
```

## Generate predictions for ASFR

Create a data frame for values to predict---all age groups in each year from 1995 through 2017.

``` {r}
df_pred <- crossing(period = 1995:2017,
                    agegr = levels(asfr$agegr),
                    pys = 1,
                    v025 = levels(asfr$v025))
```

Generate predictions log ASFR and return standard error

```{r}
pred<- predict(mod, newdata = df_pred, se.fit = TRUE)


df_pred <- data.frame(df_pred, pred) %>%
  mutate(asfr = exp(fit),
         lower = exp(fit - qnorm(0.975) * se.fit),
         upper = exp(fit + qnorm(0.975) * se.fit))

```

Plot predicted vs. observed ASFR. 

``` {r echo=FALSE, warning =  FALSE, fig.show='hold', fig.height=5.0, fig.width=7, fig.align = "center"}
ggplot(asfr, aes(period, asfr, color = surveyid)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), data = df_pred, color = NA, fill = "darkred", alpha = 0.3) +
  geom_line(data = df_pred, color = "darkred") +
  # ylim(0, 0.5) +
  facet_grid(v025~agegr)
```

Outliers in 2015 DHS in urban areas:
```{r echo=FALSE}

asfr %>%
  select(-c(country, survyear)) %>%
  arrange(., desc(asfr)) %>%
  head(n=3)

```
# Mixed effects model

Introduce random intercept and slope for age group over time. 

`mod2 <- glmer(births ~ agegr*period + v025 + (1 + period | agegr) , family = poisson, data = asfr2, offset = log(pys))`

Fails to fit. Reduce the TIPS of the DHS surveys to 0-7:

``` {r eval=FALSE}
Map(calc_asfr, ir,
              by = list(~surveyid + country + survyear+ v025),
              tips = list("DHS" = c(0, 7), "MIS" = c(0, 5))[surveys$SurveyType],
              period = list(1995:2017),
              counts = TRUE)
```

Still fails to fit.

Collapse top 2 age groups to reduce 0 counts. Tried to do this through the `agegr` argument in `calc_asfr` but couldn't resolve `Error in tcut(data[[tstart]] - data[[dob]], agegr * scale, .epis_labels(agegr)) : Number of labels must equal number of intervals` in `demog_pyears()`. Messy code:

``` {r eval=FALSE}

asfr2 <- asfr %>%
  mutate(births = round(births),
           pys = round(pys),
           sum_var = ifelse(agegr=="40-44" | agegr=="45-49", TRUE, FALSE)) %>%
    group_by(surveyid, country,  survyear,tips,  v025, period, sum_var) %>%
    mutate(births = ifelse(sum_var, sum(births), births), 
           pys = ifelse(sum_var, sum(pys), pys),
           asfr = births/pys,
           agegr = plyr::revalue(agegr, c("40-44" = "40-49")),
           agegr = factor(agegr, levels=c("15-19", "20-24", "25-29", "30-34", "35-39", "40-49"))
    ) %>%
    droplevels() %>%
    ungroup() %>%
    select(-sum_var) %>%
    distinct(surveyid, country, survyear, tips,v025, period, births, pys, asfr, .keep_all=TRUE)

```

Model run throws an error: `Error in (function (fr, X, reTrms, family, nAGQ = 1L, verbose = 0L, maxit = 100L,  : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate`.

Combine both the shortened DHS TIPS and the collapsed upper age groups. Does run, though reports an error of being a singular fit. The random effects don't add anything to the model at this stage (which is the intepretation of the very small variances around them below - i.e. variation is adequately explained by the fixed effects?)

``` {r mixed effects model, echo=FALSE, warning = FALSE}

asfr2 <- Map(calc_asfr, ir,
              by = list(~surveyid + country + survyear+ v025),
              tips = list("DHS" = c(0, 7), "MIS" = c(0, 5))[surveys$SurveyType],
              period = list(1995:2017),
              counts = TRUE)
  
  ## Combine births and pys from 40-44 and 45-49 age groups to reduce 0 counts?
  asfr2 <- asfr2 %>%
    bind_rows %>%
    type.convert %>%
    mutate(v025 = factor(v025, levels= c(1,2), labels = c("Urban", "Rural"))) %>%
    filter(period <= survyear) %>%
    mutate(births = round(births),
           pys = round(pys),
           sum_var = ifelse(agegr=="40-44" | agegr=="45-49", TRUE, FALSE)) %>%
    group_by(surveyid, country,  survyear,tips,  v025, period, sum_var) %>%
    mutate(births = ifelse(sum_var, sum(births), births), 
           pys = ifelse(sum_var, sum(pys), pys),
           asfr = births/pys,
           agegr = plyr::revalue(agegr, c("40-44" = "40-49")),
           agegr = factor(agegr, levels=c("15-19", "20-24", "25-29", "30-34", "35-39", "40-49"))
    ) %>%
    droplevels() %>%
    ungroup() %>%
    select(-sum_var) %>%
    distinct(surveyid, country, survyear, tips,v025, period, births, pys, asfr, .keep_all=TRUE)
  
  mod2 <- glmer(births ~ agegr*period + v025 + (1 + period | agegr) , family = poisson, data = asfr2, offset = log(pys))
  
  summary(mod2)
```

## Predict & plot ASFRs

As before - prediction data frame. `se.fit` not available within `lme4` so no uncertainty around fitted ASFRs

```{r}
df_pred2 <- crossing(period = 1995:2017,
                       agegr = levels(asfr2$agegr),
                       pys = 1,
                       v025 = levels(asfr2$v025))
  
  pred2 <- predict(mod2, newdata = df_pred2)
  
  df_pred2 <- data.frame(df_pred2, pred2) %>%
    mutate(asfr = exp(pred2))
```
```{r echo=FALSE, fig.height=5, fig.width=8}
  ggplot(asfr2, aes(period, asfr, color = surveyid)) +
    geom_point() +
    geom_line() +
    geom_line(data = df_pred2, aes(y=asfr), color = "darkred") +
    facet_grid(v025~agegr)
```