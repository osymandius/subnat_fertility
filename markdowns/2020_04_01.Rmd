---
title: "2020_04_01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages and get population data

```{r message=FALSE, warning=FALSE, results="hide"}
library(TMB)
library(INLA)
library(tidyverse)
library(abind)
library(sf)
library(spdep)
library(Matrix)
library(countrycode)
library(haven)
library(survival)
library(parallel)
library(demogsurv)
devtools::load_all("~/Documents/GitHub/naomi")
# library(naomi)
library(here)

naomi_data_path <- "~/Documents/GitHub/naomi-data"
# naomi_data_path <- "~/GitHub/naomi-data"

source(here("R/inputs.R"))
source(here("R/fertility_funs.R"))

iso3_current <- "ZWE"

##sorry..
list2env(make_areas_population("ZWE", naomi_data_path, full = FALSE), globalenv())
```

## Get ASFR data and make design matrices & structure matrices for RWs and ICAR

```{r message=FALSE, warning=FALSE, results="hide"}

asfr <- get_asfr_pred_df("ZWE", 2, project = FALSE)

mf <- make_model_frames(iso3_current, population, asfr, mics_asfr = NULL)

X_mf <- model.matrix(~1, mf$mf_model)

Z_spatial <- sparse.model.matrix(~0 + area_id, mf$mf_model)
Z_age <- sparse.model.matrix(~0 + age_group, mf$mf_model)
Z_period <- sparse.model.matrix(~0 + period, mf$mf_model)

M_obs <- sparse.model.matrix(~0 + idx, mf$dist$obs) 
Z_tips <- sparse.model.matrix(~0 + tips_f, mf$dist$obs)
X_tips_dummy <- model.matrix(~0 + tips_dummy, mf$dist$obs)

R_spatial <- make_adjacency_matrix("ZWE", areas_long, boundaries, 2)
R_tips <- make_rw_structure_matrix(ncol(Z_tips), 1, TRUE)
R_age <- make_rw_structure_matrix(ncol(Z_age), 1, TRUE)
R_period <- make_rw_structure_matrix(ncol(Z_period), 2, TRUE)

```

## Run TMB model

``` {r message=FALSE, warning=FALSE, results="hide"}

# dyn.unload(dynlib(here("tmb/fertility_tmb_dev")))
compile(here("tmb/fertility_tmb_dev.cpp"))               # Compile the C++ file
dyn.load(dynlib(here("tmb/fertility_tmb_dev")))

data <- list(X_mf = X_mf,
             M_obs = M_obs,
             Z_age = Z_age,
             Z_period = Z_period,
             Z_spatial = Z_spatial,
             R_tips = R_tips,
             R_age = R_age,
             R_period = R_period,
             R_spatial = R_spatial,
             log_offset = log(mf$dist$obs$pys),
             births_obs = mf$dist$obs$births,
             pop = mf$mf_model$population,
             A_out = mf$out$A_out
             )

par <- list(
            beta_mf = rep(0, ncol(X_mf)),
            u_age = rep(0, ncol(Z_age)),
            u_period = rep(0, ncol(Z_period)),
            u_spatial_str = rep(0, ncol(Z_spatial)),
            u_spatial_iid = rep(0, ncol(Z_spatial)),
            log_sigma_rw_period = log(2.5),
            log_sigma_rw_age = log(2.5),
            log_sigma_spatial = log(2.5),
            logit_spatial_rho = 0
            )
             
obj <-  MakeADFun(data = data,
                parameters = par,
                DLL = "fertility_tmb_dev",
                #  random = c("beta_mf", "beta_tips_dummy", "u_tips", "u_age", "u_period", "u_spatial_str", "u_spatial_iid", "eta1", "eta2", "eta3"),
                random = c("beta_mf", "u_age", "u_period", "u_spatial_str", "u_spatial_iid"),
                hessian = FALSE)

f <- nlminb(obj$par, obj$fn, obj$gr)
f$par.fixed <- f$par
f$par.full <- obj$env$last.par

fit <- c(f, obj = list(obj))
fit$sdreport <- sdreport(fit$obj, fit$par)
fit <- sample_tmb_test(fit)

qtls <- apply(fit$sample$lambda_out, 1, quantile, c(0.025, 0.5, 0.975))

```

## Run INLA model 

```{r message=FALSE, warning=FALSE, results="hide"}

formula <- births ~ 
  f(id.age_group, model="rw1") + 
  f(id.period, model="rw2") + 
  f(id.district, model="bym2", graph=here("countries/ZWE/adj/ZWE_admin2.adj"))

inla_mod <- run_mod_nat(formula, asfr)
inla_res <- get_mod_results_test(inla_mod, asfr)

```

## Graph comparison

```{r message=FALSE, warning=FALSE}

mf$out$mf_out %>%
  mutate(lower = qtls[1,],
         median = qtls[2,],
         upper = qtls[3,],
         source = "tmb") %>%
  type.convert() %>%
  bind_rows(inla_res %>% mutate(source = "inla")) %>%
  left_join(areas_long) %>%
  filter(area_level ==2, age_group == "20-24") %>%
  ggplot(aes(x=period, y=median, group=source)) +
    geom_line(aes(color = source)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill=source), alpha=0.3) +
    facet_wrap(~area_id) +
    ylim(0,0.5)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

hyper <- inla_mod$internal.marginals.hyperpar

inla_untransformed_hyper <- list(
  age = data.frame(x=hyper[[1]][,1], y=hyper[[1]][,2]),
  period = data.frame(x=hyper[[2]][,1], y=hyper[[2]][,2]),
  district = data.frame(x=hyper[[3]][,1], y=hyper[[3]][,2]),
  district_phi = data.frame(x=hyper[[4]][,1], y=hyper[[4]][,2])
)

gridExtra::grid.arrange(
data.frame(val=fit$sample$log_tau_rw_age, source = "tmb log tau") %>%
  ggplot(aes(color=source)) +
    geom_density(aes(x=val)) +
    geom_point(data=inla_untransformed_hyper$age %>% mutate(source = "INLA log precision"), aes(x=x, y=y)) +
    labs(title="Age"),

data.frame(val=fit$sample$log_tau_rw_period, source = "tmb log tau") %>%
  ggplot(aes(color=source)) +
  geom_density(aes(x=val)) +
  geom_point(data=inla_untransformed_hyper$period %>% mutate(source = "INLA log precision"), aes(x=x, y=y)) +
  labs(title="Period"),

data.frame(val=fit$sample$log_sigma_spatial, source = "tmb log sigma") %>%
  ggplot(aes(color=source)) +
  geom_density(aes(x=val)) +
  geom_point(data=inla_untransformed_hyper$district %>% mutate(source = "INLA log precision"), aes(x=x, y=y)) +
  labs(title="Spatial"),

data.frame(val=fit$sample$logit_spatial_rho, source = "tmb logit rho") %>%
  ggplot(aes(color=source)) +
  geom_density(aes(x=val)) +
  geom_point(data=inla_untransformed_hyper$district_phi %>% mutate(source = "INLA logit phi"), aes(x=x, y=y)) +
  labs(title="Rho (tmb), phi (INLA")
)
```