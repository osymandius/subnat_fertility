---
title: "Estimation of subnational fertility in SSA"
author: "Oli Stevens"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
  keep_md: true
# vignette: >
#   %\VignetteIndexEntry{Model-based smoothing of child mortality trends}
# %\VignetteEngine{knitr::rmarkdown}
# %\VignetteEncoding{UTF-8}
---
  
  ```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  cache = TRUE,
  comment = "#>"
)
```
This is some intro text about how I went and did the thing.

## Load packages

```{r load packages, results=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(rdhs)
library(demogsurv)
library(lme4)
```


## Calculate ASFR, TFR, and GFR

Use `rdhs` and `demogsurv` to calculate ASFR & TFR for Malawi.

```{r datasets}

##+ datasets
surveys <- dhs_surveys(countryIds = "MW", surveyYearStart=1995)
ird <- dhs_datasets(fileType = "IR", fileFormat = "flat", surveyIds = surveys$SurveyId)
ird$path <- unlist(get_datasets(ird))
```

## Load the datasets into R as a list and asssign survey-level variables

```{r}
ir <- lapply(ird$path, readRDS) %>%
  Map(data.frame,
      surveyid = surveys$SurveyId,
      country = surveys$CountryName,
      survyear = surveys$SurveyYear,
      survtype = surveys$SurveyType,
      .,
      stringsAsFactors = FALSE)
      
```
## Calculate TFR 

Calculate annual (calendar periods) TFR estimates for 0-10 years preceding each DHS survey or 0 to 5 years preceding each MIS.

Shorten the TIPS for 2015 DHS to 0-8 due to outliers in urban for 10 year recall.

```{r}
tips_surv <- ifelse(surveys$SurveyId == "MW2015DHS", list(c(0, 9)), 
                         ifelse(surveys$SurveyType == "DHS", list(c(0, 10)), list(c(0, 5))))

names(tips_surv) <- unique(surveys$SurveyId)
```

tips_surv2 <- list(c(0,5))

Calculate TFR by survey year & urban/rural (`v025`)

```{r}
tfr <- Map(calc_tfr, ir,
           by = list(~surveyid + country + survyear + v025),
           tips = tips_surv,
           period = list(1995:2017))

tfr <- tfr %>%
  bind_rows %>%
  type.convert %>% 
  filter(period <= survyear) %>%
  mutate(lower = tfr - qnorm(0.975) * se_tfr,
         upper = tfr + qnorm(0.975) * se_tfr)
```

## Plot annual TFR estimates

```{r echo=FALSE, fig.show='hold', fig.height=3.8, fig.width=5.0, fig.align = "center"}
ggplot(tfr, aes(period, tfr, ymin = lower, ymax = upper,
                color=surveyid, fill=surveyid)) +
  geom_point() +
  geom_line() +
  geom_ribbon(alpha=0.2, linetype="blank") +
  ggtitle("TFR") +
  theme(legend.position="bottom") +
  ylim(0, 12.5) +
  facet_grid(~v025)
```

## Calculate ASFR and births / PYs

Calculate annual (calendar periods) TFR estimates for 0-10 years preceding each DHS survey or 0 to 5 years preceding each MIS. Argument `counts = TRUE`indicates to return the counts of weighted births and person-years.

### FIXED EFFECTS ONLY
{
##+ warning = FALSE
foo <- Map(calc_asfr, ir,
            by = list(~surveyid + country + survyear+ v025),
            tips = tips_surv,
            period = list(1995:2017),
            counts = TRUE)

## Combine births and pys from 40-44 and 45-49 age groups to reduce 0 counts?
asfr <- foo %>%
  bind_rows %>%
  type.convert %>%
  filter(period <= survyear)

  mutate(births = round(births),
         pys = round(pys),
         sum_var = ifelse(agegr=="40-44" | agegr=="45-49", TRUE, FALSE)) %>%
  group_by(surveyid, country,  survyear,tips,  v025, period, sum_var) %>%
  mutate(births = ifelse(sum_var, sum(births), births), 
         pys = ifelse(sum_var, sum(pys), pys),
         asfr = births/pys
  ) %>%
  ungroup() %>%
  select(-sum_var) %>%
  distinct(surveyid, country, survyear, tips,v025, period, births, pys, asfr, .keep_all=TRUE)

#' ## Fit model
#'
#' Fit Poisson GLM with log-linear time trend for each age group

##+ warning = FALSE
mod <- glm(births ~ agegr*period + v025, family = poisson, data = asfr, offset = log(pys))

summary(mod)
summary(mod2)


#' ## Generate predictions for ASFR

#' Create a data frame for values to predict---all age groups in each year from 1995 through 2017.
df_pred <- crossing(period = 1995:2017,
                    agegr = c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49"),
                    pys = 1,
                    v025 = unique(asfr$v025))

#' Generate predictions log ASFR and return standard error
pred<- predict(mod, newdata = df_pred, se.fit = TRUE)


df_pred <- data.frame(df_pred, pred) %>%
  mutate(asfr = exp(fit),
         lower = exp(fit - qnorm(0.975) * se.fit),
         upper = exp(fit + qnorm(0.975) * se.fit))


#' Plot predicted vs. observed ASFR

##+ fig.show='hold', fig.height=5.0, fig.width=7, fig.align = "center"
ggplot(asfr, aes(period, asfr, color = surveyid)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), data = df_pred, color = NA, fill = "darkred", alpha = 0.3) +
  geom_line(data = df_pred, color = "darkred") +
  ylim(0, 0.5) +
  facet_grid(v025~agegr)
```

Age-adjusted fertility against time. Left hand plot - 2000 is base reference year. Right hand plot - multiplied by TFR in 2000

``` {r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7}

glm.RR <- function(GLM.RESULT, digits = 2) {

  COEF      <- stats::coef(GLM.RESULT)
  CONFINT   <- stats::confint(GLM.RESULT)
  TABLE     <- cbind(coef=COEF, CONFINT)
  TABLE.EXP <- round(exp(TABLE), digits)
  
  colnames(TABLE.EXP)[1] <- "RR"
  
  TABLE.EXP
}

p2 <- data.frame(glm.RR(m2)) 
p2a <- p2 %>%
  `colnames<-`(c("RR", "lower", "upper")) %>%
  mutate(var = rownames(.)) %>%
  separate(var, into=c("var", "year"), sep="(?<=[A-Za-z])(?=[0-9])") %>%
  filter(var=="survyear") %>%
  rbind(c(1, NA, NA, "survyear", 2000)) %>%
  mutate_at(c("RR", "lower", "upper", "year"), as.numeric)

p2a.1 <- p2a %>%
  ggplot(aes(x=year, y=RR, ymin=lower, ymax=upper)) +
    geom_line() +
    geom_errorbar(width = 0.25) +
    labs(y="FRR")

p2a.2 <- p2a %>%
  mutate_at(c("RR", "lower", "upper"), ~(.*tfr[["MW2000DHS"]][["tfr"]])) %>%
  ggplot(aes(x=year, y=RR, ymin=lower, ymax=upper)) +
    geom_line() +
    geom_errorbar(width = 0.25) +
    labs(y="TFR")

grid.arrange(p2a.1, p2a.2, ncol=2)

```

Fertility by age group adjusted by time. Left hand plot - 15-19 is base reference year. Right hand plot - multiplied by ASFR for 15-19 calculated from all surveys.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7}

p3a <- p2 %>%
  `colnames<-`(c("RR", "lower", "upper")) %>%
  mutate(var = rownames(.)) %>%
  separate(var, into=c("var", "age"), sep="(?<=[A-Za-z])(?=[0-9])") %>%
  filter(var=="agegr") %>%
  rbind(c(1, NA, NA, "agegr", "15-19")) %>%
  mutate(age = factor(age, levels = c( "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49"))) %>%
  mutate_at(c("RR", "lower", "upper"), as.numeric)

p3a.1 <- p3a %>%
  ggplot(aes(x=age, y=RR, ymin=lower, ymax=upper, group=1)) +
    stat_summary(fun.y=sum, geom="line") +
    geom_errorbar(width = 0.25) +
    labs(y="FRR")

# Calculating ASFR for 15-19 across all survey years = 0.15

# avg_base_asfr <- asfr_mod_data %>%
#   group_by(tips, agegr) %>%
#   summarise(births = sum(births),
#             pys = sum(pys)) %>%
#   mutate(asfr = births/pys) %>%
#   .[1,5]

p3a.2 <- p3a %>%
  mutate_at(c("RR", "lower", "upper"), ~(.*0.15)) %>%
  ggplot(aes(x=age, y=RR, ymin=lower, ymax=upper, group=1)) +
    stat_summary(fun.y=sum, geom="line") +
    geom_errorbar(width = 0.25) +
    labs(y="ASFR")

grid.arrange(p3a.1, p3a.2, ncol=2)
```

With interaction between survey year and age group

``` {r}

m1 <- glm(births ~ survyear*agegr, data=asfr_mod_data, family = poisson(), offset=log(pys))

```
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=6}

plot(effect(term="survyear:agegr", mod=m1), multiline=TRUE)

```